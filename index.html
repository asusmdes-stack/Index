<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telega Stats</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <h1 id="welcome"></h1>
  <script>
    // === Telegram WebApp Debug ===
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe?.user;
    const initData = tg.initData;

    console.log("=== Telegram WebApp Debug ===");
    console.log("User object:", user);
    console.log("üü¢ initData:", initData);

    const welcome = document.getElementById("welcome");

    if (user) {
      welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name || "–¥—Ä—É–≥"}!`;
    } else {
      welcome.textContent = "–ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å (–≤–Ω–µ Telegram)!";
    }

    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏—à–ª–∏ –æ—Ç Telegram
    if (initData && user?.id) {
      const payload = {
        initData: initData,
        user: user,
      };

      console.log("‚û°Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...");
      console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º fetch –Ω–∞:", window.location.origin + "/api/save-user");

      fetch("/api/save-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(async res => {
        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Å—Ç–∞—Ç—É—Å):", res.status);
        const data = await res.json();
        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (JSON):", data);

        if (!res.ok) {
          console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data.error);
        } else {
          console.log("‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
        }
      })
      .catch(err => {
        console.error("üö® –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
      });
    } else {
      console.warn("‚ö†Ô∏è –ù–µ—Ç initData –∏–ª–∏ user.id ‚Äî –∑–∞–ø—É—Å–∫ –≤–Ω–µ Telegram");
    }
  </script>
</body>
</html>
